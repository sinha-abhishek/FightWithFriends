<html>
    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/ocanvas-2.4.0.min.js"></script>
    <head> 
        <title> Testing Web Socket... </title> 
        <!-- Le styles -->
        <link href="assets/css/bootstrap.css" rel="stylesheet">
        <style type="text/css">
          body {
            padding-top: 20px;
            padding-bottom: 60px;
          }

          /* Custom container */
          .container {
            margin: 0 auto;
            max-width: 1000px;
          }
          .container > hr {
            margin: 60px 0;
          }

          /* Main marketing message and sign up button */
          .jumbotron {
            margin: 80px 0;
            text-align: center;
          }
          .jumbotron h1 {
            font-size: 100px;
            line-height: 1;
          }
          .jumbotron .lead {
            font-size: 24px;
            line-height: 1.25;
          }
          .jumbotron .btn {
            font-size: 21px;
            padding: 14px 24px;
          }

          /* Supporting marketing content */
          .marketing {
            margin: 60px 0;
          }
          .marketing p + h4 {
            margin-top: 28px;
          }


          /* Customize the navbar links to be fill the entire space of the .navbar */
          .navbar .navbar-inner {
            padding: 0;
          }
          .navbar .nav {
            margin: 0;
            display: table;
            width: 100%;
          }
          .navbar .nav li {
            display: table-cell;
            width: 1%;
            float: none;
          }
          .navbar .nav li a {
            font-weight: bold;
            text-align: center;
            border-left: 1px solid rgba(255,255,255,.75);
            border-right: 1px solid rgba(0,0,0,.1);
          }
          .navbar .nav li:first-child a {
            border-left: 0;
            border-radius: 3px 0 0 3px;
          }
          .navbar .nav li:last-child a {
            border-right: 0;
            border-radius: 0 3px 3px 0;
          }
        </style>
        <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
        <script src="assets/js/html5shiv.js"></script>
        <![endif]-->

        <!-- Fav and touch icons -->
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png">
        <link rel="shortcut icon" href="assets/ico/favicon.png">
    </head>
    <body>
        <div id="fb-root"></div>
        <script>
            var socket_io_loaded = false;
            var fb_connected = false;
            var fb_response = null;

            if(typeof io == "undefined") {
                $.getScript('http://' + window.location.hostname + ':8028/socket.io/socket.io.js', function() {
                    socketIoLoaded();
                });
            }

            window.fbAsyncInit = function() {
                FB.init({
                    appId      : '165829500255032', // App ID
                    channelUrl : '//fwf.localhost.com/channel.html', // Channel File
                    status     : true, // check login status
                    cookie     : true, // enable cookies to allow the server to access the session
                    xfbml      : true  // parse XFBML
                });
                FB.Event.subscribe('auth.authResponseChange', function(response) {
                    // Here we specify what we do with the response anytime this event occurs. 
                    if (response.status === 'connected') {
                        fbConnected();
                    } else if (response.status === 'not_authorized') {
                        FB.login();
                    } else {
                        FB.login();
                    }
                });
            };

            // Load the SDK asynchronously
            (function(d){
                var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
                if (d.getElementById(id)) {return;}
                js = d.createElement('script'); js.id = id; js.async = true;
                js.src = "//connect.facebook.net/en_US/all.js";
                ref.parentNode.insertBefore(js, ref);
            }(document));

            function socketIoLoaded() {
                socket_io_loaded = true;
                if(fb_connected) {
                    loadCompleted();
                }
            }

            function fbConnected() {
                FB.api('/me', function(response) {
                    fb_response = response;
                    console.log(fb_response);
                    fb_connected = true;
                    if(socket_io_loaded) {
                        loadCompleted();
                    }
                });
            }

            var clientName = 'unknown-no-login';
            var clientId = 'unknown-id-no-login';
            var socket = null;
            var listOfRooms = {};
            var currentRoom = null;

            var positionArray = new Array();
            var currentServerPositionArray = new Array();

            function loadCompleted() {
                socket = io.connect('http://' + window.location.hostname + ':8028', { 'connect timeout': 10000 });
                makeEventListeners();
            }

            function makeEventListeners() {
                socket.on('connect', function() {
                    setClientDetails(fb_response);
                });

                socket.on('disconnect', function() {
                    //not sure if this is even required - might not even work...
                    if(currentRoom != null) {
                        leaveRoom();
                    }
                });

                socket.on('registered', function(data) {
                    clientName = data.clientName;
                    listOfRooms = data.existingRooms;
                    populateListOfRooms();
                });

                socket.on('joined', function(data) {
                    currentRoom = data.room;
                    positionArray = data.value;
                    createBoxes(data.value)
                });

                socket.on('roomUpdate', function (data) {
                    var updateFrom = data.clientName;
                    var updateType = data.eventName;
                    var value = data.value;
                    if(updateType == 'update') {
                        positionArray = value;
                    } else if(updateType == 'join') {
                        addBox(value.position);
                    } else if(updateType == 'leave') {
                        removeBox(updateFrom);
                    }
                    console.log("Client: " + updateFrom + " Event: " + updateType + " Value: " + value);
                });

                socket.on('reAdjust', function (data) {
                    currentServerPositionArray = data.value;
                });
            }

            function setClientDetails(data) {
                socket.emit('setClientDetails', data);
            }

            function joinRoom(roomName) {
                socket.emit('joinRoom', { room: roomName });
            }

            function leaveRoom() {
                socket.emit('leaveRoom', { room: currentRoom });
            }

            function stateUpdate(posX, posY) {
                socket.emit('stateUpdate', { position: { x: posX, y: posY } });
            }

        </script>
		<div class="container-fluid">
            <div class="row-fluid">
                <div class="span2">
                    <fb:login-button show-faces="true" width="200" max-rows="1"></fb:login-button>
                    <br />
                    <br />
                    <select id='roomList' name='roomListSelect'>
                    </select>
                    <a class="btn" id="joinSelected" href="#">JOIN</a>
                    <br />
                    <br />
                    <input type='text' id='roomName' align='left' name='roomNameBtn'/>
                    <a class="btn" id="createRoom" href="#">CREATE</a>
                </div>
                <div class="span6">
                    <div id="main_canvas">
                        <canvas id="canvas1" width="760" height="465" style="border:1px; background-image: url(assets/img/background_map.png);">
                        </canvas>
                    </div>
                </div>
            </div>
        </div>
        <script>

            $('#joinSelected').click( function() {
                joinRoom($("#roomList option:selected").text());
            });

            $('#createRoom').click( function() {
                joinRoom($('#roomName').val());
            });

            var canvasDoc = document.getElementById('canvas1');
            var canvasWidth = canvasDoc.width;
            var canvasHeight = canvasDoc.height;

            var canvas = oCanvas.create({
                canvas: "#canvas1",
                fps: 10
            });

            var boxes = new Array();

            canvasDoc.onmousedown = function (event) {
                var relX = event.offsetX / canvasDoc.width;
                var relY = event.offsetY / canvasDoc.height;
                stateUpdate( relX, relY );
            }

            var canvasLoop = canvas.setLoop(function () {
                //check currentServerPositionArray also, if its very different, proportionally move it to that instead. Lets keep it at 5% of game board.
                for (var i = 0; i < positionArray.length; i++) {
                    var remX = (positionArray[i].position.x * canvasDoc.width) - boxes[i].x;
                    var remY = (positionArray[i].position.y * canvasDoc.height)- boxes[i].y;
                    var dist = Math.sqrt(Math.pow(remX, 2) + Math.pow(remY, 2));
                    if(dist != 0) {
                        boxes[i].x += (remX / dist);
                        boxes[i].y += (remY / dist);
                    }

                    if( Math.abs((boxes[i].x / canvasDoc.width) - currentServerPositionArray[i].position.x) > 0.005 ) {
                        boxes[i].x = currentServerPositionArray[i].position.x * canvasDoc.width;
                    }

                    if( Math.abs((boxes[i].y / canvasDoc.height) - currentServerPositionArray[i].position.y) > 0.005 ) {
                        boxes[i].y = currentServerPositionArray[i].position.y * canvasDoc.height;
                    }

                }
            });

            function Box(position) {
                var button = canvas.display.rectangle({
                    x: position.x,
                    y: position.y,
                    origin: { x: "center", y: "center" },
                    width: 60,
                    height: 40,
                    fill: "linear-gradient(315deg, #079, #013)",
                    shadow: "0 0 20px rgba(0,0,0, 0.8)"
                });
                return button;
            }

            function removeBox(clientName) {
                for (var i = 0; i < positionArray.length; i++) {
                    if(positionArray[i].clientName == clientName) {
                        canvas.removeChild(boxes[i]);
                        boxes.splice(i,1);
                    }
                }
            }

            function createBoxes(value) {
                for (var i = 0; i < value.length; i++) {
                    addBox(value[i].position);
                }
                canvasLoop.start();
            }

            function addBox(position) {
                boxes.push(Box(position));
                canvas.addChild(boxes[boxes.length - 1]);
            }

            function populateListOfRooms() {
                for (var roomName in listOfRooms) {
                    $("#roomList").append("<option value='1'>" + roomName.replace('/','') + "</option>") 
                }
            }

        </script>
    </body>
</html>
