<html>
<head> 
    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/canvasengine-1.2.6.all.min.js"></script>
    <script src="protected/player.js"></script>
        <title> Fight With Friends! </title> 
        <!-- Le styles -->
        <link href="assets/css/bootstrap.css" rel="stylesheet">
        <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
        <link href="assets/css/main.css" rel="stylesheet">

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
        <script src="assets/js/html5shiv.js"></script>
        <![endif]-->

        <!-- Fav and touch icons -->
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png">
        <link rel="shortcut icon" href="assets/ico/favicon.png">
</head>
    <body >
        <div id="start_screen">
            <div class="jumbotron">
                <h1>FIGHT WITH FRIENDS!!</h1>
                <p class="lead">Team up with your friends! Improve your Kingdom, and make your way through others' - Show them that you can RULE!</p>
            </div>
            <div id="login_div" class="jumbotron" style="width: 300; margin-right: auto; margin-left: auto;">
                <h2 class="form-signin-heading">Please sign in</h2>
                <input id="loginId" type="text" class="input-block-level" placeholder="Username">
                <input type="password" class="input-block-level" placeholder="Password">
                <a id="login_button" class="btn btn-large btn-success" href="#">Start Playing</a>
                <!--<button id="login_button" class="btn btn-large btn-primary" type="submit">Start Playing!</button>-->
                <h4 class="form-signin-heading">Don't feel like creating an account? This is just for you:</h4>
                <a id="anonymous_button" class="btn btn-large btn-primary" href="#">Just GO GO!</a>
            </div>
            <div id="loading_div" class="container" style="display: none; width: 400;">
                <h1 "text-align:center">Loading...</h1>
                <div class="progress progress-striped active">
                    <div id="progress_bar" class="bar" style="width: 0%;"></div>
                </div>
            </div>
        </div>
        <script>
            var socket_io_loaded = false;
            var login_entered = false;
            var towers_loaded = false;
            var units_loaded = false;
            var unit_images_loaded = false;
            var tower_images_loaded = false;
            var login_data = null;
            var unit_data = null;
            var tower_data = null;
            var towerImages = {};
            var unitImages = {};
            var towerProjectileImages = {};
            var unitProjectileImages = {};

            var load_status = 0;
            var load_total = 6;

            var towerImagesLoaded = 0;
            var towerImagesToLoad = 0;
            var unitImagesLoaded = 0;
            var unitImagesToLoad = 0;

            $('#login_button,#anonymous_button').click( function() {
                var login = '';
                if(!$('input[id=loginId]').val()) {
                    login = "anonymous:" + Math.round(new Date().getTime()/1000).toString().slice(-5);
                } else {
                    login = $('input[id=loginId]').val();
                }
                login_data = { id: login, username: login };
                login_entered = true;
                load_status++;
                $("#login_div").hide();
                $("#loading_div").show();
                checkIfLoadComplete();
                return false;
            });

            $.getJSON('settings/units.json', function(data) {
                unit_data = data;
                units_loaded = true;
                load_status++;
                loadUnitImages();
                checkIfLoadComplete();
            });

            $.getJSON('settings/towers.json', function(data) {
                tower_data = data;
                towers_loaded = true;
                load_status++;
                loadTowerImages();
                checkIfLoadComplete();
            });

            function loadUnitImages() {
                for(var key in unit_data) {
                    var imgsrc = unit_data[key].image;
                    unitImages[key] = new Image();
                    unitImagesToLoad++;
                    unitImages[key].onload = function(){
                        unitImagesLoaded ++;
                    };
                    unitImages[key].src = imgsrc;
                }

                for(var key in unit_data) {
                    var imgsrc = unit_data[key].projectileImage;
                    var img = new Image();
                    img.key = key;
                    unitImagesToLoad++;
                    img.onload = function(){
                        unitImagesLoaded ++;
                        unitProjectileImages[this.key] = this;
                        if(unitImagesLoaded == unitImagesToLoad) {
                            unit_images_loaded = true;
                            load_status++;
                            checkIfLoadComplete();
                        }
                    };
                    img.src = imgsrc;
                }
            }

            function loadTowerImages() {
                for(var key in tower_data) {
                    var imgsrc = tower_data[key].image;
                    towerImages[key] = new Image();
                    towerImagesToLoad++;
                    towerImages[key].onload = function(){
                        towerImagesLoaded ++;
                    };
                    towerImages[key].src = imgsrc;
                }

                for(var key in tower_data) {
                    var imgsrc = tower_data[key].projectileImage;
                    var img = new Image();
                    img.key = key;
                    towerImagesToLoad++;
                    img.onload = function(){
                        towerImagesLoaded ++;
                        towerProjectileImages[this.key] = this;
                        if(towerImagesLoaded == towerImagesToLoad) {
                            tower_images_loaded = true;
                            load_status++;
                            checkIfLoadComplete();
                        }
                    };
                    img.src = imgsrc;
                }
            }

            if(typeof io == "undefined") {
                $.getScript('http://' + window.location.hostname + ':8028/socket.io/socket.io.js', function() {
                    socket_io_loaded = true;
                    load_status++;
                    checkIfLoadComplete();
                });
            }


            function checkIfLoadComplete() {
                $("#progress_bar").width = Math.floor(100 * load_status / load_total );
                if(units_loaded && towers_loaded && socket_io_loaded && tower_images_loaded && unit_images_loaded && login_entered) {
                    loadCompleted();
                }
            }

			var TOTAL_UNITS = 5;
			var SERVER = false;
			var categories = { Attacker : 1, Defender : 2, Voyeur : 3 };
			var COLORS = new Array("blue", "red", "green", "yellow");
            var isInDesignMode = false;
			
            var userDetails = null;
            var socket = null;
            var listOfRooms = {};
            var currentRoom = null;
            var myRoom = null;
			
            var positionArray = new Array();
            var currentServerPositionArray = new Array();
			var me 				= null;
			var playersOnBoard 	= {};
			var currentSelectedUnit = null;
			
			//var whoami			= categories.Attacker;
            var whoami          = categories.Defender;
			var batchedStates 	= new Array();

            function loadCompleted() {
                socket = io.connect('http://' + window.location.hostname + ':8028', { 'connect timeout': 10000 });
                $("#start_screen").hide();
                $("#gamediv").show();
                makeEventListeners();
            }
			
            function makeEventListeners() {
                socket.on('connect', function() {
                    setClientDetails(login_data);
                });

                socket.on('disconnect', function() {
                    //not sure if this is even required - might not even work...
                    if(currentRoom != null) {
                        leaveRoom();
                    }
                });

                socket.on('iregistered', function(data) {
					console.log("iregistered");
                    userDetails = data.userDetails;
                    if (data.towers) {
                        populateTowers(data.towers);
                    }
                    myRoom = currentRoom = data.room;
                    enableButtons();
                });

                socket.on('ijoined', function(data) {
					console.log("i joined " + data.room);
                    currentRoom = data.room;
					$.each(data.value, function(index, state) {
						if (state.id != me.id) {
							var opp = new Player(state.name, state.id, false);
							playersOnBoard[state.id] = opp;
							playersOnBoard[state.id].updatePosition(state);
						}
					});
					whoami          = categories.Attacker;
                    $('#friendList').html("");
                    enableButtons();
                });

                socket.on('roomUpdate', function (data) {
                    var updateFrom = data.clientName;
                    var updateFromId = data.clientId;
                    var updateType = data.eventName;
                    var value = data.value;
                    if(updateType == 'update') {
						// no more comes here
                        
                    } else if(updateType == 'join') {
                        // create an opponent player object
						var opp = new Player(updateFrom, updateFromId, false);
						playersOnBoard[opp.id] = opp;
						// add to the player list
                    } else if(updateType == 'leave') {
                        //removeBox(updateFrom);
                    }
                    console.log("Client: " + updateFrom + " Event: " + updateType + " Value: " + value);
                });

				socket.on('updateRoomList', function (data) {
					listOfRooms = data.value.existingRooms;
					populateListOfRooms();
				});
				
                socket.on('reAdjust', function (data) {
                    //currentServerPositionArray = data.value;
                    if(data.battleOver) {
                        indicateBattleOverAndReset();
                        return;
                    }
					$.each(data.value, function(index, state) {
						playersOnBoard[state.id].updatePosition(state);
					});
                });
            }

            function setClientDetails(data) {
				me = new Player(data.username, data.id, false);
				playersOnBoard[me.id] = me;
				$("#whoami").html(me.name);
                socket.emit('login', data);
            }

            function joinRoom(roomName) {
				// first leave the room you are in
				leaveRoom();
				// reset your canvas
				mcanvas = mainScene.getCanvas();
				mcanvas.clear();
				
                socket.emit('joinRoom', { room: roomName });
            }

            function leaveRoom() {
				// reset the player units and towers before leaving
				me.leaveRoom();
                socket.emit('leaveRoom', { room: currentRoom });
            }

            function stateUpdate(posX, posY) {
                socket.emit('stateUpdate', { position: { x: posX, y: posY } });
            }
			
			function updateState(state, force) {
				if (state != null) {
					batchedStates.push(state);
				}
				//socket.emit('updateState', { states: batchedStates });
				
				// empty the array - find the right way
				//batchedStates = new Array();
			}
			
			function pushToServer() {
				if (null != me && me.unitsOnBoard() > 0) {
					states = me.getState();
					socket.emit('updateState', { states: me.getState() });
				
					// empty the array - find the right way
					batchedStates = new Array();
				}
                else if (null != me && me.towersOnBoard() > 0) {
					if (!isInDesignMode) {
						socket.emit('updateState', { states: me.getState() });
					}
                }
			}

			function enableButtons() {
				if (whoami == categories.Attacker) {
					$("#attacker_dashboard").show();
                    $("#defender_dashboard").hide();
				}
				else {
                    $("#attacker_dashboard").hide();
                    $("#defender_dashboard").show();
				}
			}
        </script>
        <div id="gamediv" style="display: none;">
            <div class="navbar navbar-inverse navbar-fixed-top">
                <div class="navbar-inner">
                    <div class="container">
                        <div class="nav-collapse collapse">
                            <ul class="nav" id="attacker_dashboard" style="display: none;">
                                <li class="">
                                    <a id="addUnit" href="#" >Add Unit</a>
                                </li>
                            </ul>
                            <ul class="nav" id="defender_dashboard">
    							<li class="" id="whoami" style="color:red">
                                </li>
                                <li class="">
                                    <a id="saveMode" href="#">Save</a>
                                </li>
                                <li class="">
                                    <a id="designMode" href="#">Design Mode</a>
                                </li>
                                <li class="">
                                    <a id="addTower" href="#">Add Tower</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
    		<div class="container-fluid">
                <div id="main_canvas">
                    <canvas id="canvas1" width="1600" height="1200" style="border:1px; background-image: url(assets/img/background_map_3.png);">
                    </canvas>
                </div>
            </div>
            <div class="navbar navbar-inverse navbar-fixed-bottom">
                <div class="navbar-inner">
                    <div class="container">
                        <div class="nav-collapse collapse">

                            <ul class="nav" id="friendList">
                            </ul>
                            <form class="navbar-search pull-left" style="display: none;">
                                <input type="text" class="search-query" placeholder="Search">
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>

            function populateListOfRooms() {
                var i =0;
                $('#friendList').html("");
                for (var roomName in listOfRooms) {
					roomName = roomName.replace('/','')
                    if (!roomName || roomName == myRoom) {
                        continue;
                    }
                    i++;
                    if(i == 5) {
                        $('#friendList').html("<a href='#' class='dropdown-toggle' data-toggle='dropdown'>Other Friends <b class='caret'></b></a><ul class='dropdown-menu id=extraFriendList'></ul>");
                    }
                    if(i < 5) {
                        $('#friendList').append("<li><a class='friends' id='" + roomName + "' href='#'>" + roomName + "</a></li>");
                    }
                    else {
                        $("#extraFriendList").append("<li><a class='friends' id='" + roomName + "' href='#'>" + roomName + "</a></li>");
                    }    
                }
                $('.friends').click(function() {
                    joinRoom($(this).attr("id"));
                    return false;
                });
            }

			/* attacker dashboard */
            $('#addUnit').click( function() {
				var unitsOnBoard = me.unitsOnBoard();
                if (unitsOnBoard < TOTAL_UNITS) {
					var unit = new Unit(me, unitsOnBoard+1, {code: "001", position:{ x: 0.125, y: 0.183 }}, false, true);
				}
				return false;
            });
			
			
			/* defender dashboard */
            $('#addTower').click( function() {
				if (isInDesignMode) {
					addTower({
						code : "001",
						position : { x: 0.100, y: 0.30 }
					});
				}
				else {
					alert("you must be in design mode to add");
				}
                return false;
            });

            $('#designMode').click( function() {
                isInDesignMode = true;
                return false;
            });

            $('#saveMode').click( function() {
                isInDesignMode = false;
				states = me.getState();
                socket.emit('saveTowers', { states: me.getState() });
                return false;
            });
			

            var canvasDoc = document.getElementById('canvas1');
            var canvasWidth = canvasDoc.width;
            var canvasHeight = canvasDoc.height;

            var canvas = CE.defines("canvas1").
            ready(function() {
                canvas.Scene.call("MainScene");
            });

            var boxes = new Array();

            canvasDoc.onmouseup = function (event) {
				if (null != currentSelectedUnit) {
					var relX = (event.offsetX - (currentSelectedUnit.mapResource.width/2)) / canvasDoc.width;
					var relY = (event.offsetY - (currentSelectedUnit.mapResource.height/2)) / canvasDoc.height;
					currentSelectedUnit.updateTarget({x : relX, y : relY });
					
					currentSelectedUnit.mapResource.opacity = currentSelectedUnit.mapResource.opacity < 1 ? 1 : 0.5 ;
                    currentSelectedUnit = null;
				}
            }

            var mainScene = canvas.Scene.new({
                name: "MainScene",
                materials: {
                    images: {
                        knight: "assets/img/knight.png",
                    }
                },
                ready: function(stage) {
                },
                render: function(stage) {
                    for (var key in playersOnBoard) {
						playersOnBoard[key].update();
                    }

                    stage.refresh();
					pushToServer();
                }
            });

            function removeBox(clientName) {
                for (var i = 0; i < positionArray.length; i++) {
                    if(positionArray[i].clientName == clientName) {
                        //canvas.removeChild(boxes[i]);
                        boxes.splice(i,1);
                    }
                }
            }

            function populateTowers(listOfTowers) {
				console.log("populateTowers");
                for (var i = listOfTowers.length - 1; i >= 0; i--) {
                    addTower(listOfTowers[i])
                }
            }

            function addTower(tower) {
                var towersOnBoard = me.towersOnBoard();
                if (towersOnBoard < TOTAL_UNITS) {
                    var myTowerObj = new Tower(me,towersOnBoard+1, tower, false, true); 
                   // me.addTower(myTowerObj);
                }
            }

            function indicateBattleOverAndReset() {
                //TODO: Check if attacker or defender, reset them to their kingdoms, play music, remove filter etc.
            }

            function loadKingdom(kingdom) {
                var staticUnits = kingdom.buildings;
                var background = kingdom.theme.background;
                //background must be a URL
                //canvas.background.set("image('" + background + "'");
                //staticUnits is an array of units with each having an x and a y.
                for( var i = staticUnits.length - 1; i >= 0; i--) {
                    loadStaticUnit(staticUnits[i]);
                }
            }
            
            var currentStaticUnits = new Array();

            function loadStaticUnit(staticUnit) {
                currentStaticUnits.push(staticUnit);
            }

            function removeAllStaticUnits() {
                for( var i = currentStaticUnits.length - 1; i >= 0; i--) {
                    currentStaticUnits.splice(i,1);
                }
            }

        </script>
    </body>
</html>
