<html>
<head> 
	<script src="assets/js/global.js"></script>
    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/canvasengine-1.2.6.all.min.js"></script>
    <script src="protected/player.js"></script>
        <title> Testing Web Socket... </title> 
        <!-- Le styles -->
        <link href="assets/css/bootstrap.css" rel="stylesheet">
        <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
        <link href="assets/css/main.css" rel="stylesheet">

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
        <script src="assets/js/html5shiv.js"></script>
        <![endif]-->

        <!-- Fav and touch icons -->
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png">
        <link rel="shortcut icon" href="assets/ico/favicon.png">
</head>
    <body >
        <div id="fb-root"></div>
        <script>
            var socket_io_loaded = false;
            var fb_connected = false;
            var towers_loaded = false;
            var units_loaded = false;
            var fb_response = null;
            var unit_data = null;
            var tower_data = null;
            var towerImages = {};
            var unitImages = {};

            $.getJSON('units.json', function(data) {
                unit_data = data;
                units_loaded = true;
                checkIfLoadComplete();
            });

            $.getJSON('towers.json', function(data) {
                tower_data = data;
                towers_loaded = true;
                checkIfLoadComplete();
            });





            if(typeof io == "undefined") {
                $.getScript('http://' + window.location.hostname + ':8028/socket.io/socket.io.js', function() {
                    socket_io_loaded = true;
                    checkIfLoadComplete();
                });
            }

            window.fbAsyncInit = function() {
                FB.init({
                    appId      : FB_APP_ID, // App ID
                    channelUrl : '//' + window.location.hostname + '/channel.html', // Channel File
                    status     : true, // check login status
                    cookie     : true, // enable cookies to allow the server to access the session
                    xfbml      : true  // parse XFBML
                });
                FB.Event.subscribe('auth.authResponseChange', function(response) {
                    // Here we specify what we do with the response anytime this event occurs. 
                    if (response.status === 'connected') {
                        fbConnected();
                    } else if (response.status === 'not_authorized') {
                        FB.login();
                    } else {
                        FB.login();
                    }
                });
            };

            // Load the SDK asynchronously
            (function(d){
                var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
                if (d.getElementById(id)) {return;}
                js = d.createElement('script'); js.id = id; js.async = true;
                js.src = "//connect.facebook.net/en_US/all.js";
                ref.parentNode.insertBefore(js, ref);
            }(document));

            function fbConnected() {
                FB.api('/me', function(response) {
                    fb_response = response;
                    console.log(fb_response);
                    fb_connected = true;
                    checkIfLoadComplete();
                });
            }

            function checkIfLoadComplete() {
                if(units_loaded && towers_loaded && socket_io_loaded) {
                    loadImages();
                    //loadCompleted();
                }
            }
            var imagesLoaded = 0;
            var imagesToLoad = 0;
            function loadImages() {
                for(var key in unit_data) {
                    var imgsrc = unit_data[key].image;
                    unitImages[key] = new Image();
                    imagesToLoad++;
                    unitImages[key].onload = function(){
                        imagesLoaded ++;
                    };
                    unitImages[key].src = imgsrc;
                }

                for(var key in tower_data) {
                    var imgsrc = tower_data[key].image;
                    var img = new Image();
                    //towerImages[key] = new Image();
                    img.key = key;
                    imagesToLoad++;
                    img.onload = function(){
                        imagesLoaded ++;
                        towerImages[this.key] = this;
                        if(imagesLoaded == imagesToLoad) {
                            loadCompleted();
                        }
                    };
                    img.src = imgsrc;
                }

            }

			var TOTAL_UNITS = 4;
			var SERVER = false;
			var categories = { Attacker : 1, Defender : 2, Voyeur : 3 };
			var COLORS = new Array("blue", "red", "green", "yellow");
            var isInDesignMode = false;
			
            var userDetails = null;
            var socket = null;
            var listOfRooms = {};
            var currentRoom = null;
            var ownTowers = new Array();
            var towersOnBoard = new Array();
			
            var positionArray = new Array();
            var currentServerPositionArray = new Array();
			var me 				= null;
			var playersOnBoard 	= {};
			var currentSelectedUnit = null;
			
			//var whoami			= categories.Attacker;
            var whoami          = categories.Defender;
			var batchedStates 	= new Array();

            function loadCompleted() {
                socket = io.connect('http://' + window.location.hostname + ':8028', { 'connect timeout': 10000 });
                makeEventListeners();
            }
			
            function makeEventListeners() {
                socket.on('connect', function() {
					var rand = Math.floor(Math.random()*11);
                    setClientDetails({name : "anand" + rand, id : rand});
                });

                socket.on('disconnect', function() {
                    //not sure if this is even required - might not even work...
                    if(currentRoom != null) {
                        leaveRoom();
                    }
                });

                socket.on('registered', function(data) {
                    userDetails = data.userDetails;
                    listOfRooms = data.existingRooms;
                    populateListOfRooms();
                    populateTowers(data.towers);
                    enableButtons();
                });

                socket.on('joined', function(data) {
                    currentRoom = data.room;
					$.each(data.value, function(index, state) {
						if (state.id != me.id) {
							var opp = new Player(state.name, state.id, false);
							playersOnBoard[state.id] = opp;
							playersOnBoard[state.id].updatePosition(state);
						}
					});
					whoami          = categories.Attacker;
                    enableButtons();
                });

                socket.on('roomUpdate', function (data) {
                    var updateFrom = data.clientName;
                    var updateFromId = data.clientId;
                    var updateType = data.eventName;
                    var value = data.value;
                    if(updateType == 'update') {
                        positionArray =  value;
                    } else if(updateType == 'join') {
                        // create an opponent player object
						var opp = new Player(updateFrom, updateFromId, false);
						playersOnBoard[opp.id] = opp;
                    } else if(updateType == 'leave') {
                        //removeBox(updateFrom);
                    }
                    console.log("Client: " + updateFrom + " Event: " + updateType + " Value: " + value);
                });

                socket.on('reAdjust', function (data) {
                    //currentServerPositionArray = data.value;
					$.each(data.value, function(index, state) {
						playersOnBoard[state.id].updatePosition(state);
					});
                });
            }

            function setClientDetails(data) {
				me = new Player(data.name, data.id, false);
				playersOnBoard[me.id] = me;
                socket.emit('login', data);
            }

            function joinRoom(roomName) {
				// first leave the room you are in
				leaveRoom();
				// reset your canvas
				mcanvas = mainScene.getCanvas();
                mcanvas.clear();
				
                socket.emit('joinRoom', { room: roomName });
            }

            function leaveRoom() {
				// reset the player units and towers before leaving
				me.leaveRoom();
                socket.emit('leaveRoom', { room: currentRoom });
            }

            function stateUpdate(posX, posY) {
                socket.emit('stateUpdate', { position: { x: posX, y: posY } });
            }
			
			function updateState(state, force) {
				if (state != null) {
					batchedStates.push(state);
				}
				//socket.emit('updateState', { states: batchedStates });
				
				// empty the array - find the right way
				//batchedStates = new Array();
			}
			
			function pushToServer() {
				if (null != me && me.unitsOnBoard() > 0) {
					states = me.getState();
					socket.emit('updateState', { states: me.getState() });
				
					// empty the array - find the right way
					batchedStates = new Array();
				}
			}

			function enableButtons() {
				if (whoami == categories.Attacker) {
					$("#attacker_dashboard").show();
                    $("#defender_dashboard").hide();
				}
				else {
                    $("#attacker_dashboard").hide();
                    $("#defender_dashboard").show();
				}
			}
        </script>
        <div class="navbar navbar-inverse navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <div class="nav-collapse collapse">
                        <ul class="nav" id="attacker_dashboard" style="display: none;">
                            <li class="">
                                <a id="addUnit" href="./index.html" >Add Unit</a>
                            </li>
                        </ul>
                        <ul class="nav" id="defender_dashboard">
                            <li class="">
                                <a id="saveMode" href="#">Save</a>
                            </li>
                            <li class="">
                                <a id="designMode" href="#">Design Mode</a>
                            </li>
                            <li class="">
                                <a id="addTower" href="#">Add Tower</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
		<div class="container-fluid">
            <div id="main_canvas">
                <canvas id="canvas1" width="1600" height="1200" style="border:1px; background-image: url(assets/img/background_map_3.png);">
                </canvas>
            </div>
        </div>
        <div class="navbar navbar-inverse navbar-fixed-bottom">
            <div class="navbar-inner">
                <div class="container">
                    <div class="nav-collapse collapse">

                        <ul class="nav" id="friendList">
                        </ul>
                        <form class="navbar-search pull-left" style="display: none;">
                            <input type="text" class="search-query" placeholder="Search">
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <script>

            function populateListOfRooms() {
                var i =0;
                $('#friendList').html("");
                for (var roomName in listOfRooms) {
                    if (!roomName) {
                        continue;
                    }
                    i++;
                    if(i == 5) {
                        $('#friendList').html("<a href='#' class='dropdown-toggle' data-toggle='dropdown'>Other Friends <b class='caret'></b></a><ul class='dropdown-menu id=extraFriendList'></ul>");
                    }
                    if(i < 5) {
                        $('#friendList').append("<li><a class='friends' id='" + roomName.replace('/','') + "' href='#'>" + roomName.replace('/','') + "</a></li>");
                    }
                    else {
                        $("#extraFriendList").append("<li><a class='friends' id='" + roomName.replace('/','') + "' href='#'>" + roomName.replace('/','') + "</a></li>");
                    }    
                }
                $('.friends').click(function() {
                    joinRoom($(this).attr("id"));
                    return false;
                });
            }

			/* attacker dashboard */
            $('#addUnit').click( function() {
				var unitsOnBoard = me.unitsOnBoard();
                if (unitsOnBoard < TOTAL_UNITS) {
					var unit = new Unit(unitsOnBoard+1, {code: "001", position:{ x: 200, y: 0 }}, false, true);
					//me.addUnit(unit, false);
				}
				return false;
            });
			
			
			/* defender dashboard */
            $('#addTower').click( function() {
                addTower({
                    code: "001",
                    position: { x: 100, y: 30 }
                });
                return false;
            });

            $('#designMode').click( function() {
                //now we must have on click listeners for each tower.
                //socket.emit('saveTowers', towersOnBoard);
                isInDesignMode = true;
                return false;
            });

            $('#saveMode').click( function() {
                isInDesignMode = false;
                socket.emit('saveTowers', towersOnBoard);
                return false;
            });
			

            var canvasDoc = document.getElementById('canvas1');
            var canvasWidth = canvasDoc.width;
            var canvasHeight = canvasDoc.height;

            var canvas = CE.defines("canvas1").
            ready(function() {
                canvas.Scene.call("MainScene");
            });

            var boxes = new Array();

            canvasDoc.onmouseup = function (event) {
				if (null != currentSelectedUnit) {
                    if(currentSelectedUnit.isTower == 1) {
                        currentSelectedUnit.updateTarget({x : event.offsetX, y : event.offsetY });
                        currentSelectedUnit = null;
                        return false;
                    }
					var relX = event.offsetX / canvasDoc.width;
					var relY = event.offsetY / canvasDoc.height;
					currentSelectedUnit.updateTarget({x : relX, y : relY });
					
					currentSelectedUnit.mapResource.opacity = currentSelectedUnit.mapResource.opacity < 1 ? 1 : 0.5 ;
                    currentSelectedUnit = null;
				}
            }

            var mainScene = canvas.Scene.new({
                name: "MainScene",
                materials: {
                    images: {
                        knight: "assets/img/knight.png",
                    }
                },
                ready: function(stage) {
                },
                render: function(stage) {
                    for (var key in playersOnBoard) {
						playersOnBoard[key].update();
                    }

                    stage.refresh();
					pushToServer();
                }
            });

            function AttackUnitResource(position) {
                var button = mainScene.createElement(64,64);
                var imageObj = new Image();
                imageObj.onload = function() {
                    button.drawImage(imageObj);
                }
                //TODO: MUST USE ACTUAL UNIT CODE HERE!!!
                imageObj.src = unit_data["001"].image;
                return button;
            }

            function removeBox(clientName) {
                for (var i = 0; i < positionArray.length; i++) {
                    if(positionArray[i].clientName == clientName) {
                        //canvas.removeChild(boxes[i]);
                        boxes.splice(i,1);
                    }
                }
            }

            function populateTowers(listOfTowers) {
                for (var i = listOfTowers.length - 1; i >= 0; i--) {
                    addTower(listOfTowers[i], false)
                }
            }

            function addTower(tower) {
                var towersOnBoard = me.towersOnBoard();
                if (towersOnBoard < TOTAL_UNITS) {
                    var myTowerObj = new Tower(towersOnBoard+1, tower, false, true); 
                    me.addTower(myTowerObj);
                }
            }

            function loadKingdom(kingdom) {
                var staticUnits = kingdom.buildings;
                var background = kingdom.theme.background;
                //background must be a URL
                //canvas.background.set("image('" + background + "'");
                //staticUnits is an array of units with each having an x and a y.
                for( var i = staticUnits.length - 1; i >= 0; i--) {
                    loadStaticUnit(staticUnits[i]);
                }
            }
            
            var currentStaticUnits = new Array();

            function loadStaticUnit(staticUnit) {
                /*
                var staticUnit = canvas.display.rectangle({
                    x: position.x,
                    y: position.y,
                    origin: { x: "center", y: "center" },
                    width: 60,
                    height: 40,
                    fill: "linear-gradient(315deg, #079, #013)",
                    shadow: "0 0 20px rgba(0,0,0, 0.8)"
                });
                canvas.addChild(staticUnit);
                */
                currentStaticUnits.push(staticUnit);
            }

            function removeAllStaticUnits() {
                for( var i = currentStaticUnits.length - 1; i >= 0; i--) {
                    //canvas.removeChild(currentStaticUnits[i]);
                    currentStaticUnits.splice(i,1);
                }
            }

        </script>
    </body>
</html>
