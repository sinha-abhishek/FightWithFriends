<html lang="en">
    <head>
        <title> New Index </title>
        <style>
            body {
                background:#b4a088;
                padding:0;
                margin:0;
                overflow:hidden;
                font-family:georgia;
                text-align:center;
                color: #ccc;
            }
            h1 {color: #ccc; }
            a { color:skyblue }
            canvas { pointer-events:none; z-index:10; }
        </style>
    </head>
    <body>
        <script src="assets/js/jquery.js"></script>
        <script src="assets/js/three.min.js"></script>
        <script src="includes/map.js"></script>
        <script src="includes/unit.js"></script>
        <script src="includes/preloader.js"></script>
        <script>

        /** TEMPORARY VARIABLES FOR CHECKING - REMOVE OR MOVE TO INNER LATER */
        var g_unit;

            var SCREEN_WIDTH = window.innerWidth;
            var SCREEN_HEIGHT = window.innerHeight;

            var FLOOR = -250;

            var container;

            var camera, SCENE, projector;
            var canvasRenderer, webglRenderer;
            var zmesh, geometry;

            var windowHalfX = window.innerWidth / 2;
            var windowHalfY = window.innerHeight / 2;

            var render_canvas = 1, render_gl = 1;
            var has_gl = 0;

            preload(function() {
                init();
                animate();   
            });

            function init() {

                container = document.createElement( 'div' );
                document.body.appendChild( container );

                camera = new THREE.PerspectiveCamera( 75, SCREEN_WIDTH / SCREEN_HEIGHT, 1, 100000 );
                camera.position.z = 500;
                camera.position.y = -600;

                SCENE = new THREE.Scene();

                projector = new THREE.Projector();

                // RENDERER
                try {

                    webglRenderer = new THREE.CanvasRenderer({
                        antialias: true
                    });
                    webglRenderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );
                    webglRenderer.domElement.style.position = "relative";

                    container.appendChild( webglRenderer.domElement );

                    has_gl = 1;

                }
                catch (e) {
                }

                loadMap(SCENE);
                g_unit = new DrawableUnit("001", {x: 10, y: 10}, true);
                g_unit.moveTo(5,5);
            }

            function animate() {
                requestAnimationFrame( animate );
                render();
            }

            function render() {
                var time = new Date().getTime();
                for( var key in OBJECTS_ON_BOARD) {
                    if(OBJECTS_ON_BOARD[key].unitObj) {
                        OBJECTS_ON_BOARD[key].unitObj.performMove(time);  
                    } else if(OBJECTS_ON_BOARD[key].projectileObj) {
                        OBJECTS_ON_BOARD[key].unitObj.performMove(time);
                    }
                }
                camera.lookAt( SCENE.position );
                if ( render_gl && has_gl ) webglRenderer.render( SCENE, camera );
            }

            document.addEventListener( 'mousedown', onDocumentMouseDown, false );
            function onDocumentMouseDown( event ) {
                event.preventDefault();

                var vector = new THREE.Vector3(
                    ( event.clientX / window.innerWidth ) * 2 - 1,
                    - ( event.clientY / window.innerHeight ) * 2 + 1,
                    0.5 );

                projector.unprojectVector( vector, camera );
                var dir = vector.sub( camera.position ).normalize();

                if(GLOBAL_SELECTED_UNIT) {
                    var distance = - camera.position.z / dir.z;

                    var pos = camera.position.clone().add( dir.multiplyScalar( distance ) );
                    GLOBAL_SELECTED_UNIT.moveTo(pos.x, pos.y);
                    GLOBAL_SELECTED_UNIT = null;
                } else {
                    var ray = new THREE.Raycaster( camera.position, dir );

                    var intersects = ray.intersectObjects( OBJECTS_ON_BOARD );

                    if(intersects.length > 0) {
                        if( intersects[0].object.unitObj ) {
                            GLOBAL_SELECTED_UNIT = intersects[0].object.unitObj;
                        }
                    }
                }
            }
        </script>
    </body>
</html>
